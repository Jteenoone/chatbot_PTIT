<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Tr·ª£ l√Ω ·∫¢o PTIT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .scrollbar::-webkit-scrollbar{ width: 8px }
    .scrollbar::-webkit-scrollbar-thumb{ background:#e5e7eb; border-radius:8px }
  </style>
</head>
<body class="h-screen bg-gradient-to-b from-red-50 to-white text-gray-900">

  <header class="border-b border-red-100 bg-white/70 sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 grid place-items-center rounded-xl bg-red-600 text-white font-bold">PT</div>
        <h1 class="text-lg font-semibold text-red-700">Tr·ª£ l√Ω ·∫¢o PTIT</h1>
      </div>
      <div>
        <a href="/admin" class="text-xs px-3 py-1 border border-red-200 text-red-700 rounded-lg hover:bg-red-50">Trang qu·∫£n tr·ªã</a>
      </div>
    </div>
  </header>

  <div class="flex max-w-6xl mx-auto h-[calc(100vh-76px)] mt-6 gap-6 px-4">
    <!-- Sidebar -->
    <aside class="w-1/5 bg-white border border-red-100 rounded-2xl p-4 overflow-y-auto scrollbar">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-red-700">L·ªãch s·ª≠</h2>
        <form method="POST" action="/new-session">
          <button type="submit" class="text-xs px-2 py-1 border rounded-md text-red-700 border-red-200">New chat</button>
        </form>
      </div>

     {% if sessions %}
        <div class="space-y-2">
          {% for s in sessions|reverse %}
            <div class="p-3 rounded-lg border border-red-100 bg-white">
              <div class="flex items-start justify-between gap-2">
                <a href="{{ url_for('index') }}?session_id={{ s.id }}" class="text-sm text-gray-800 truncate block w-2/3">
                  {{ s.name }}
                </a>
                <div class="flex gap-2 items-center">
                  <form method="GET" action="{{ url_for('index') }}">
                    <input type="hidden" name="session_id" value="{{ s.id }}">
                    <input type="hidden" name="rename" value="1">
                    <button type="submit" class="text-xs text-blue-500">‚úèÔ∏è</button>
                  </form>
                  <form method="POST" action="/delete-session" class="inline-block">
                    <input type="hidden" name="session_id" value="{{ s.id }}" />
                    <button type="submit" class="text-xs text-red-500">üóëÔ∏è</button>
                  </form>
                </div>
              </div>
              <div class="mt-2 text-xs text-gray-500">{{ s.created }}</div>
              {% if request.args.get('rename') == '1' and request.args.get('session_id') == s.id %}
                <form method="POST" action="/rename-session" class="mt-2 flex gap-2">
                  <input name="session_id" type="hidden" value="{{ s.id }}" />
                  <input name="new_name" type="text" placeholder="Nh·∫≠p t√™n m·ªõi..."
                         class="flex-1 text-sm border border-red-200 rounded px-2 py-1 focus:ring-1 focus:ring-red-500" />
                  <button type="submit" class="text-sm bg-red-600 text-white px-2 py-1 rounded">üíæ</button>
                </form>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-500 text-sm">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</p>
      {% endif %}
    </aside>

    <!-- Chat area -->
    <main class="flex-1 bg-white border border-red-100 rounded-2xl p-4 flex flex-col">
      <div class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar" id="chat-window">
        {% if current %}
          {% for m in current.messages %}
            {% if m.role == 'user' %}
              <div class="flex justify-end items-start gap-3">
                <div class="max-w-[80%] rounded-2xl px-4 py-3 bg-red-600 text-white">{{ m.text }}</div>
                <div class="w-9 h-9 rounded-full bg-gray-800 text-white grid place-items-center">üë§</div>
              </div>
            {% else %}
              <div class="flex items-start gap-3">
                <div class="w-9 h-9 rounded-full bg-red-600 text-white grid place-items-center">ü§ñ</div>
                <div class="max-w-[80%] rounded-2xl px-4 py-3 border border-red-100 bg-white whitespace-pre-wrap">{{ m.text }}</div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-full bg-red-600 text-white grid place-items-center">ü§ñ</div>
            <div class="max-w-[80%] rounded-2xl px-4 py-3 border border-red-100 bg-white">
              Ch√†o b·∫°n üëã M√¨nh l√† Tr·ª£ l√Ω ·∫¢o PTIT. H√£y ƒë·∫∑t c√¢u h·ªèi li√™n quan ƒë·∫øn PTIT nh√©!
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Input form -->
      <form method="POST" action="/send" id="chat-form"
            class="border-t border-red-100 pt-3 mt-3 flex gap-3 items-end">
        <input type="hidden" name="session_id" id="session-id" value="{{ current.id if current else '' }}" />
        <textarea id="chat-input" name="message" rows="2" placeholder="Nh·∫≠p c√¢u h·ªèi..." required
          class="flex-1 rounded-xl border border-red-200 px-3 py-2 resize-none"></textarea>
        <button type="submit" id="send-btn" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition-colors">G·ª≠i</button>
      </form>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const textarea = document.getElementById("chat-input");
      const form = document.getElementById("chat-form");
      const chatWindow = document.getElementById("chat-window");
      const sendBtn = document.getElementById("send-btn");
      const sessionIdInput = document.getElementById("session-id");

      let thinkingElement = null;
      let dotsInterval = null;

      textarea.focus();
      chatWindow.scrollTop = chatWindow.scrollHeight;

      textarea.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const message = textarea.value.trim();
        if (!message) return;

        addUserMessage(message);
        textarea.value = "";
        textarea.disabled = true;
        sendBtn.disabled = true;
        sendBtn.classList.add("opacity-50", "cursor-not-allowed");

        showThinking();

        try {
          const formData = new FormData();
          formData.append("message", message);
          formData.append("session_id", sessionIdInput.value);

          const response = await fetch("/send", { method: "POST", body: formData });
          const data = await response.json();
          removeThinking();

          if (!response.ok || !data.success) {
            addBotMessage("‚ùå L·ªói: " + (data.error || "Kh√¥ng x√°c ƒë·ªãnh."));
          } else {
            if (data.session_id) sessionIdInput.value = data.session_id;
            addBotMessage(data.reply);
          }
        } catch (error) {
          console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", error);
          removeThinking();
          addBotMessage("‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i tin nh·∫Øn!");
        }

        textarea.disabled = false;
        sendBtn.disabled = false;
        sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
        textarea.focus();
      });

      function addUserMessage(text) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "flex justify-end items-start gap-3";
        msgDiv.innerHTML = `
          <div class="max-w-[80%] rounded-2xl px-4 py-3 bg-red-600 text-white">${escapeHtml(text)}</div>
          <div class="w-9 h-9 rounded-full bg-gray-800 text-white grid place-items-center">üë§</div>
        `;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function addBotMessage(text) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "flex items-start gap-3";
        msgDiv.innerHTML = `
          <div class="w-9 h-9 rounded-full bg-red-600 text-white grid place-items-center">ü§ñ</div>
          <div class="max-w-[80%] rounded-2xl px-4 py-3 border border-red-100 bg-white whitespace-pre-wrap">${escapeHtml(text)}</div>
        `;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function showThinking() {
        thinkingElement = document.createElement("div");
        thinkingElement.className = "flex items-start gap-3";
        thinkingElement.innerHTML = `
          <div class='w-9 h-9 rounded-full bg-red-600 text-white grid place-items-center'>ü§ñ</div>
          <div class='max-w-[80%] rounded-2xl px-4 py-3 border border-red-100 bg-gray-50 text-gray-600 italic'>
            Chatbot ƒëang suy nghƒ©<span id="dots">...</span>
          </div>
        `;
        chatWindow.appendChild(thinkingElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        const dots = thinkingElement.querySelector("#dots");
        let i = 0;
        dotsInterval = setInterval(() => {
          dots.textContent = ".".repeat((i++ % 3) + 1);
        }, 500);
      }

      function removeThinking() {
        if (dotsInterval) {
          clearInterval(dotsInterval);
          dotsInterval = null;
        }
        if (thinkingElement) {
          thinkingElement.remove();
          thinkingElement = null;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    });
  </script>
</body>
</html>
